# Maintainer: 7Ji <pugokughin@gmail.com>

_desc="flippy's AArch64-focused fork aiming to increase usability. Cross-build alternative"

pkgbase=linux-aarch64-flippy
pkgname=(
  "${pkgbase}"
  "${pkgbase}-headers"
  "${pkgbase}-dtb-allwinner"
  "${pkgbase}-dtb-amlogic"
  "${pkgbase}-dtb-rockchip"
)
pkgver=6.1.51
pkgrel=1
arch=('aarch64')
url="https://github.com/unifreq/linux-6.1.y"
license=('GPL2')
options=(!strip)
source=(
  "kernel.tar"
  'dtbs.tar'
  'headers.tar'
)
sha256sums=(
  'SKIP'
  'SKIP'
  'SKIP'
)
noextract=("${source[@]##*/}")

_dtb_common_pkg="${pkgbase}-dtb"

package_linux-aarch64-flippy() {
  pkgdesc="The Linux Kernel and module - ${_desc}"
  depends=(
    "${_dtb_common_pkg}"
    'coreutils'
    'initramfs'
    'kmod'
  )
  optdepends=(
    "${pkgbase}-headers: to build other modules"
    'uboot-legacy-initrd-hooks: to generate uboot legacy initrd images'
    'linux-firmware-amlogic-ophub: firmware for Amlogic SoCs'
    'wireless-regdb: to set the correct wireless channels of your country'
    "${pkgbase}-dtb-allwinner: dtbs for Allwinner SoCs"
    "${pkgbase}-dtb-amlogic: dtbs for Amlogic SoCs"
    "${pkgbase}-dtb-rockchip: dtbs for Rockchip SoCs"
  )
  provides=(
    "${pkgbase}=${pkgver}"
  )
  conflicts=(
    "${pkgbase}"
  )
  backup=(
    "etc/mkinitcpio.d/${pkgbase}.preset"
  )
  tar -C "${pkgdir}" -xf "${srcdir}/kernel.tar"
  chown -R "$(id --user):$(id --group)" "${pkgdir}" # Otherwise fakeroot will be confused due to too many layers of chroot
  chmod -R 755 "${pkgdir}"
}

package_linux-aarch64-flippy-headers() {
  pkgdesc="Header files and scripts for building modules for linux kernel - ${_desc}"
  provides=(
    "${pkgbase}-headers=${pkgver}"
  )
  conflicts=(
    "${pkgbase}-headers"
  )
  tar -C "${pkgdir}" -xf "${srcdir}/headers.tar"
  chown -R "$(id --user):$(id --group)" "${pkgdir}" # Otherwise fakeroot will be confused due to too many layers of chroot
  chmod -R 755 "${pkgdir}"
}

_dtb_common_provides="${_dtb_common_pkg}=${pkgver}"

package_linux-aarch64-flippy-dtb-allwinner() {
  pkgdesc="DTB files for Allwinner SoCs for flippy's AArch64 kernel"
  provides=(
    "${_dtb_common_provides}"
    "${pkgbase}-dtb-allwinner=${pkgver}"
  )
  conflicts=(
    "${pkgbase}-dtb-allwinner"
  )
  local _dtb_dir_suffix="boot/dtbs/${pkgbase}/allwinner"
  tar -C "${pkgdir}" -xf "${srcdir}/dtbs.tar" "${_dtb_dir_suffix}"
  chown -R "$(id --user):$(id --group)" "${pkgdir}" # Otherwise fakeroot will be confused due to too many layers of chroot
  chmod -R 755 "${pkgdir}"
}

package_linux-aarch64-flippy-dtb-amlogic() {
  pkgdesc="DTB files for Amlogic SoCs for flippy's AArch64 kernel"
  provides=(
    "${_dtb_common_provides}"
    "${pkgbase}-dtb-amlogic=${pkgver}"
  )
  conflicts=(
    "${pkgbase}-dtb-amlogic"
  )
  local _dtb_dir_suffix="boot/dtbs/${pkgbase}/amlogic"
  tar -C "${pkgdir}" -xf "${srcdir}/dtbs.tar" "${_dtb_dir_suffix}"
  chown -R "$(id --user):$(id --group)" "${pkgdir}" # Otherwise fakeroot will be confused due to too many layers of chroot
  chmod -R 755 "${pkgdir}"
}

package_linux-aarch64-flippy-dtb-rockchip() {
  pkgdesc="DTB files for Rockchip SoCs for flippy's AArch64 kernel"
  provides=(
    "${_dtb_common_provides}"
    "${pkgbase}-dtb-rockchip=${pkgver}"
  )
  conflicts=(
    "${pkgbase}-dtb-rockchip"
  )
  local _dtb_dir_suffix="boot/dtbs/${pkgbase}/rockchip"
  tar -C "${pkgdir}" -xf "${srcdir}/dtbs.tar" "${_dtb_dir_suffix}"
  chown -R "$(id --user):$(id --group)" "${pkgdir}" # Otherwise fakeroot will be confused due to too many layers of chroot
  chmod -R 755 "${pkgdir}"
}
